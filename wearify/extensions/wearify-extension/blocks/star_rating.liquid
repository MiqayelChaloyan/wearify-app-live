{% assign avg_rating = block.settings.product.metafields.demo.avg_rating.value | round %}
{% assign enabled_flag = false %}
{%- if product and product.metafields.wearify.enabled -%}
  {% assign enabled_flag = product.metafields.wearify.enabled.value %}
{%- elsif block.settings.product and block.settings.product.metafields.wearify.enabled -%}
  {% assign enabled_flag = block.settings.product.metafields.wearify.enabled.value %}
{%- endif -%}
{% if enabled_flag == true or enabled_flag == 'true' %}
  {% assign wearify_image_url = '' %}
  {% if block.settings.custom_image != blank %}
    {% assign wearify_image_url = block.settings.custom_image | image_url: width: 600 %}
  {% elsif block.settings.product and block.settings.product.featured_image %}
    {% assign wearify_image_url = block.settings.product.featured_image | image_url: width: 600 %}
  {% elsif product and product.featured_image %}
    {% assign wearify_image_url = product.featured_image | image_url: width: 600 %}
  {% endif %}
  {% assign wearify_product_title = '' %}
  {% if block.settings.product %}
    {% assign wearify_product_title = block.settings.product.title %}
  {% elsif product %}
    {% assign wearify_product_title = product.title %}
  {% else %}
    {% assign wearify_product_title = block.settings.product_name_override %}
  {% endif %}
  
  {% comment %} Debug: Check if we have product title {% endcomment %}
  {% if wearify_product_title == blank %}
    {% comment %} Try to get title from page context as fallback {% endcomment %}
    {% if page_title contains ' - ' %}
      {% assign wearify_product_title = page_title | split: ' - ' | first %}
    {% elsif page_title %}
      {% assign wearify_product_title = page_title %}
    {% endif %}
    
    {% comment %} Additional fallback: try to get from product handle or other sources {% endcomment %}
    {% if wearify_product_title == blank and product.handle %}
      {% assign wearify_product_title = product.handle | replace: '-', ' ' | capitalize %}
    {% endif %}
    
    {% comment %} Final fallback: use a default title {% endcomment %}
    {% if wearify_product_title == blank %}
      {% assign wearify_product_title = 'Product' %}
    {% endif %}
  {% endif %}
  {% assign wearify_product_id = '' %}
  {% if block.settings.product %}
    {% assign wearify_product_id = block.settings.product.id %}
  {% elsif product %}
    {% assign wearify_product_id = product.id %}
  {% else %}
    {% assign wearify_product_id = block.settings.product_id_override %}
  {% endif %}
  
  {% comment %} Get API key with multiple fallbacks {% endcomment %}
  {% assign wearify_api_key = '' %}
  
  {% comment %} Debug: Check what metafields are available {% endcomment %}
  <!-- Debug: Product metafields available: {{ product.metafields | map: 'key' | join: ', ' }} -->
  <!-- Debug: Block product metafields available: {{ block.settings.product.metafields | map: 'key' | join: ', ' }} -->
  
  {% if block.settings.api_key_override != blank %}
    {% assign wearify_api_key = block.settings.api_key_override %}
    <!-- Debug: Using API key override -->
  {% elsif product and product.metafields.wearify.key %}
    {% assign wearify_api_key = product.metafields.wearify.key.value %}
    <!-- Debug: Using product metafield API key -->
  {% elsif block.settings.product and block.settings.product.metafields.wearify.key %}
    {% assign wearify_api_key = block.settings.product.metafields.wearify.key.value %}
    <!-- Debug: Using block product metafield API key -->
  {% endif %}
  
  {% comment %} Debug: Check API key extraction {% endcomment %}
  {% if wearify_api_key == blank %}
    <!-- Debug: API key is blank, trying alternative methods -->
    {% comment %} Try alternative metafield access methods {% endcomment %}
    {% if product and product.metafields.wearify.key.value %}
      {% assign wearify_api_key = product.metafields.wearify.key.value %}
      <!-- Debug: Found API key via alternative product method -->
    {% elsif block.settings.product and block.settings.product.metafields.wearify.key.value %}
      {% assign wearify_api_key = block.settings.product.metafields.wearify.key.value %}
      <!-- Debug: Found API key via alternative block product method -->
    {% endif %}
  {% endif %}
  
  {% comment %} Debug output - remove in production {% endcomment %}
  <!-- Wearify Debug: Product Title = "{{ wearify_product_title }}" -->
  <!-- Wearify Debug: Product ID = "{{ wearify_product_id }}" -->
  <!-- Wearify Debug: Product Image = "{{ wearify_image_url }}" -->
  <!-- Wearify Debug: API Key = "{{ wearify_api_key }}" -->
  
  <div
    id="wearify-root"
    data-product-id="{{ wearify_product_id }}"
    data-product-image="{{ wearify_image_url }}"
    data-product-name="{{ wearify_product_title | escape }}"
    data-api-key="{{ wearify_api_key }}"
  ></div>
{% endif %}
{% schema %}
{
  "name": "Wearify Try On",
  "target": "section",
  "javascript": "index-eBiFPT-D.js",
  "settings": [
    { "type": "product", "id": "product", "label": "product", "autofill": true },
    { "type": "text", "id": "product_id_override", "label": "Fallback product ID" },
    { "type": "text", "id": "product_name_override", "label": "Fallback product name" },
    { "type": "text", "id": "api_key_override", "label": "API Key Override (optional)" },
    { "type": "color", "id": "colour", "label": "Star Colour", "default": "#ff0000" },
    { "type": "image_picker", "id": "custom_image", "label": "Override image" }
  ]
}
{% endschema %}

