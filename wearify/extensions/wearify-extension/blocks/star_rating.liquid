{% assign avg_rating = block.settings.product.metafields.demo.avg_rating.value | round %}
{% assign enabled_flag = false %}
{%- if product and product.metafields.wearify.enabled -%}
  {% assign enabled_flag = product.metafields.wearify.enabled.value %}
{%- elsif block.settings.product and block.settings.product.metafields.wearify.enabled -%}
  {% assign enabled_flag = block.settings.product.metafields.wearify.enabled.value %}
{%- endif -%}
{% if enabled_flag == true or enabled_flag == 'true' %}
  {% assign wearify_image_url = '' %}
  {% if block.settings.custom_image != blank %}
    {% assign wearify_image_url = block.settings.custom_image | image_url: width: 600 %}
  {% elsif block.settings.product and block.settings.product.featured_image %}
    {% assign wearify_image_url = block.settings.product.featured_image | image_url: width: 600 %}
  {% elsif product and product.featured_image %}
    {% assign wearify_image_url = product.featured_image | image_url: width: 600 %}
  {% endif %}
  {% assign wearify_product_title = '' %}
  {% assign wearify_product_price = 0 %}
  {% if block.settings.product %}
    {% assign wearify_product_title = block.settings.product.title %}
    {% if block.settings.product.selected_or_first_available_variant %}
      {% assign wearify_product_price = block.settings.product.selected_or_first_available_variant.price %}
    {% else %}
      {% assign wearify_product_price = block.settings.product.price %}
    {% endif %}
  {% elsif product %}
    {% assign wearify_product_title = product.title %}
    {% if product.selected_or_first_available_variant %}
      {% assign wearify_product_price = product.selected_or_first_available_variant.price %}
    {% else %}
      {% assign wearify_product_price = product.price %}
    {% endif %}
  {% else %}
    {% assign wearify_product_title = block.settings.product_name_override %}
    {% assign wearify_product_price = block.settings.product_price_override %}
  {% endif %}
  
  {% comment %} Debug: Check if we have product title {% endcomment %}
  {% if wearify_product_title == blank %}
    {% comment %} Try to get title from page context as fallback {% endcomment %}
    {% if page_title contains ' - ' %}
      {% assign wearify_product_title = page_title | split: ' - ' | first %}
    {% elsif page_title %}
      {% assign wearify_product_title = page_title %}
    {% endif %}
  {% endif %}
  {% assign wearify_product_id = '' %}
  {% if block.settings.product %}
    {% assign wearify_product_id = block.settings.product.id %}
  {% elsif product %}
    {% assign wearify_product_id = product.id %}
  {% else %}
    {% assign wearify_product_id = block.settings.product_id_override %}
  {% endif %}
  
  {% comment %} Get API key with multiple fallbacks {% endcomment %}
  {% assign wearify_api_key = '' %}
  {% if block.settings.api_key_override != blank %}
    {% assign wearify_api_key = block.settings.api_key_override %}
  {% elsif product and product.metafields.wearify.key %}
    {% assign wearify_api_key = product.metafields.wearify.key.value %}
  {% elsif block.settings.product and block.settings.product.metafields.wearify.key %}
    {% assign wearify_api_key = block.settings.product.metafields.wearify.key.value %}
  {% endif %}
  
  {% comment %} Debug output - remove in production {% endcomment %}
  <!-- Wearify Debug: Product Title = "{{ wearify_product_title }}" -->
  <!-- Wearify Debug: Product ID = "{{ wearify_product_id }}" -->
  <!-- Wearify Debug: Product Image = "{{ wearify_image_url }}" -->
  <!-- Wearify Debug: Product Price = "{{ wearify_product_price }}" -->
  <!-- Wearify Debug: API Key = "{{ wearify_api_key }}" -->
  
  <div
    id="wearify-root"
    data-product-id="{{ wearify_product_id }}"
    data-product-image="{{ wearify_image_url }}"
    data-product-name="{{ wearify_product_title | escape }}"
    data-product-price="{{ wearify_product_price }}"
    data-api-key="{{ wearify_api_key }}"
  ></div>
  
  <script>
    // Function to fetch API key from the app
    async function fetchWearifyApiKey() {
      try {
        console.log('Fetching Wearify API key...');
        // Get shop from the current domain
        const shop = window.location.hostname.replace('.myshopify.com', '');
        const response = await fetch(`/apps/wearify/api/public/wearify-key?shop=${shop}`, {
          method: 'GET'
        });
        console.log('Response status:', response.status);
        
        if (response.ok) {
          const data = await response.json();
          console.log('API key response:', data);
          return data.apiKey;
        } else {
          console.log('API call failed, using fallback');
          return null;
        }
      } catch (error) {
        console.error('Failed to fetch Wearify API key:', error);
        return null;
      }
    }

    // Initialize Wearify data
    async function initializeWearifyData() {
      console.log('Initializing Wearify data...');
      const apiKey = await fetchWearifyApiKey();
      console.log('Fetched API key:', apiKey);
      
      // Update the data attribute on the root element
      const rootElement = document.getElementById('wearify-root');
      if (rootElement) {
        console.log('Root element found, current data-api-key:', rootElement.getAttribute('data-api-key'));
        if (apiKey) {
          rootElement.setAttribute('data-api-key', apiKey);
          console.log('Updated data-api-key to:', apiKey);
          // Also update the window.wearifyData object if it exists
          if (window.wearifyData) {
            window.wearifyData.apiKey = apiKey;
            console.log('Updated window.wearifyData.apiKey to:', apiKey);
          }
        } else {
          console.log('No API key received, keeping current value:', rootElement.getAttribute('data-api-key'));
        }
      } else {
        console.error('Root element not found');
      }
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeWearifyData);
    } else {
      initializeWearifyData();
    }
  </script>
{% endif %}
{% schema %}
{
  "name": "Wearify Try On",
  "target": "section",
  "javascript": "index-eBiFPT-D.js",
  "settings": [
    { "type": "product", "id": "product", "label": "product", "autofill": true },
    { "type": "text", "id": "product_id_override", "label": "Fallback product ID" },
    { "type": "text", "id": "product_name_override", "label": "Fallback product name" },
    { "type": "text", "id": "product_price_override", "label": "Fallback product price (in cents)" },
    { "type": "text", "id": "api_key_override", "label": "API Key Override (optional)" },
    { "type": "color", "id": "colour", "label": "Star Colour", "default": "#ff0000" },
    { "type": "image_picker", "id": "custom_image", "label": "Override image" }
  ]
}
{% endschema %}

