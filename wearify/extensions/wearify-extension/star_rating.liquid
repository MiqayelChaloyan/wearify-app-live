{% assign enabled_flag = false %}
{%- if product and product.metafields.wearify.enabled -%}
  {% assign enabled_flag = product.metafields.wearify.enabled.value %}
{%- elsif block and block.settings and block.settings.product and block.settings.product.metafields.wearify.enabled -%}
  {% assign enabled_flag = block.settings.product.metafields.wearify.enabled.value %}
{%- endif -%}

{% if enabled_flag == true or enabled_flag == 'true' %}
  {% comment %} Get product data {% endcomment %}
  {% assign wearify_image_url = '' %}
  {% if product and product.featured_image %}
    {% assign wearify_image_url = product.featured_image | image_url: width: 600 %}
  {% endif %}
  
  {% assign wearify_product_title = '' %}
  {% if product %}
    {% assign wearify_product_title = product.title %}
  {% endif %}
  
  {% comment %} Debug: Check if we have product title {% endcomment %}
  {% if wearify_product_title == blank %}
    {% comment %} Try to get title from page context as fallback {% endcomment %}
    {% if page_title contains ' - ' %}
      {% assign wearify_product_title = page_title | split: ' - ' | first %}
    {% elsif page_title %}
      {% assign wearify_product_title = page_title %}
    {% endif %}
    
    {% comment %} Additional fallback: try to get from product handle or other sources {% endcomment %}
    {% if wearify_product_title == blank and product.handle %}
      {% assign wearify_product_title = product.handle | replace: '-', ' ' | capitalize %}
    {% endif %}
    
    {% comment %} Final fallback: use a default title {% endcomment %}
    {% if wearify_product_title == blank %}
      {% assign wearify_product_title = 'Product' %}
    {% endif %}
  {% endif %}
  
  
  {% assign wearify_product_id = '' %}
  {% if product %}
    {% assign wearify_product_id = product.id %}
  {% endif %}
  
  {% comment %} Get API key with fallbacks {% endcomment %}
  {% assign wearify_api_key = '' %}
  
  {% comment %} Debug: Check what metafields are available {% endcomment %}
  <!-- Debug: Product metafields available: {{ product.metafields | map: 'key' | join: ', ' }} -->
  <!-- Debug: Block product metafields available: {{ block.settings.product.metafields | map: 'key' | join: ', ' }} -->
  
  {% if product and product.metafields.wearify.key %}
    {% assign wearify_api_key = product.metafields.wearify.key.value %}
    <!-- Debug: Using product metafield API key -->
  {% elsif block and block.settings and block.settings.product and block.settings.product.metafields.wearify.key %}
    {% assign wearify_api_key = block.settings.product.metafields.wearify.key.value %}
    <!-- Debug: Using block product metafield API key -->
  {% endif %}
  
  {% comment %} Debug: Check API key extraction {% endcomment %}
  {% if wearify_api_key == blank %}
    <!-- Debug: API key is blank, trying alternative methods -->
    {% comment %} Try alternative metafield access methods {% endcomment %}
    {% if product and product.metafields.wearify.key.value %}
      {% assign wearify_api_key = product.metafields.wearify.key.value %}
      <!-- Debug: Found API key via alternative product method -->
    {% elsif block and block.settings and block.settings.product and block.settings.product.metafields.wearify.key.value %}
      {% assign wearify_api_key = block.settings.product.metafields.wearify.key.value %}
      <!-- Debug: Found API key via alternative block product method -->
    {% endif %}
  {% endif %}
  
  {% comment %} Debug output - remove in production {% endcomment %}
  <!-- Wearify Debug: Product Title = "{{ wearify_product_title }}" -->
  <!-- Wearify Debug: Product ID = "{{ wearify_product_id }}" -->
  <!-- Wearify Debug: Product Image = "{{ wearify_image_url }}" -->
  <!-- Wearify Debug: API Key = "{{ wearify_api_key }}" -->
  
  <div 
    id="wearify-root"
    data-product-id="{{ wearify_product_id }}"
    data-product-image="{{ wearify_image_url }}"
    data-product-name="{{ wearify_product_title | escape }}"
    data-api-key="{{ wearify_api_key }}"
  ></div>
{% endif %}


